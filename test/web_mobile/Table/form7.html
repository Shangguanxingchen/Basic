<html ng-app="NtCuxiao">
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1, maximum-scale=1.0, user-scalable=no"> 
    <meta content="telephone=no" name="format-detection" />  
    <script>
         if (document.documentElement.clientWidth > 1024) { 
           document.querySelector("meta[name=viewport]").setAttribute(
             'content', 
             'width=1024, initial-scale='+(document.documentElement.clientWidth/1024)+', minimum-scale=0.1, maximum-scale=2.0, user-scalable=no');
       }
    </script>
    <link href="assets/css/css.css?r=1849920396" media="screen" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/datatables.css">
    <link rel="stylesheet" href="assets/vendor/sm.min.css">
    <link href="assets/css/style.css"  media="screen" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/sm-nx.css">
    <script src="project.js"></script>
    <script src="assets/js/get_lang_json.js"></script>
</head>

<body class="debugx">
<div id="bg"></div>
<div id="bg_img"></div>
  <div id="container">
    <header>
        <span class="menu"></span>
        <a class="back_a" href=""><span class="menuBack"></span></a>
        <span tkey="form7"></span><span class="blue" tkey="form7_tittle"></span>
        <span class="menuRight" tkey="filter"></span>
    </header>

    <section class="filter hidden">
      <span tkey="form5_total"></span>： <span class="filter_result"></span> ；
      <span tkey="show_results"></span>： <span class="filter_total"></span> ；
      <span tkey="date"></span>： <span class="startDate"></span>/<span class="endDate"></span>
      <span class="filterButton"></span>
    </section>
<div class="condition">
    <div class="row" >
    <ul class="col-50">
      <li>
        <div class="item-content item-relative">
            <label><span tkey="form5_total"></span>:</label>
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="请选择需统计项目" class="btn-panel relative-value" data-rel="panel-result" readonly="" data-value="storage1" value="">
            </div>
          </div>
      </li>
      <li>
        <div class="item-content item-relative">
            <label><span tkey="show_results"></span>:</label>
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="请选择需统计项目" class="btn-panel relative-value" data-rel="panel-total" readonly="" data-value="storage2" value="">
            </div>
          </div>
      </li>
      <li>
        <div>
          <input type="date" data-toggle="date" class="datepicker" value="" name="start_at">
          <span class="datepicker-split">-</span>
          <input type="date" data-toggle="date" class="datepicker" value="" name="end_at">
        </div>
      </li>



      <li>
        <div class="item-content no-border item-button" style="margin-top: 40px">
          <!-- <button class="button button-fill button-primary" id="clear" tkey="clear">重置</button> -->
          <button class="button button-fill button-primary nx-btn-display" id="getList" data-table="#example" style="margin-left: 0px;" tkey="search"></button>
        </div>
      </li>
      </ul>
    </div>
  </div>
  <div class="data hidden">
      <table class="display nx-datatables" id="example" width="100%">
        <thead>
          <tr></tr>
        </thead>
      </table>

     <!--  <section class="count">
        <p class="blue label">合计|</p>
        <p class="footer"></p>
      </section> -->
      <!-- loading -->
      <div class="data_content">
        <div class="loading"></div>
        <!-- loading -->
        <div class="loader loader--style1" title="0">
          <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
          <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
            s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
            c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
          <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
            C22.32,8.481,24.301,9.057,26.013,10.047z">
            <animateTransform attributeType="xml"
              attributeName="transform"
              type="rotate"
              from="0 20 20"
              to="360 20 20"
              dur="0.5s"
              repeatCount="indefinite"/>
            </path>
          </svg>
          <p>加载中...</p>
        </div>  
      </div>
      <footer id="mainFooter">
        
      </footer>
    </div>
</div>

<!-- * 员工查询 - 销售分析 -->
<!-- 展示结果 -->
<div class="panel panel-right panel-cover" id='panel-result'>
    <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="show_results"></span>
    <a href="#" class="close-panel confirm confirm_1" tkey="sure"></a>
    </header>

    
    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small" tkey="total_desc"></p>
      <ul>
        <!-- Single chekbox item -->
        <li tkey="loading"></li>
      </ul>
      </div>
</div>
<!-- 统计方式 -->
<div class="panel panel-right panel-cover" id='panel-total'>
    <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="form5_total"></span>
    <a href="#" class="close-panel confirm confirm_2" tkey="sure"></a>
    </header>

    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small" tkey="total_desc"></p>
      <ul>
        <!-- Single chekbox item -->
        <li tkey="loading"></li>
      </ul>
      </div>
</div>


    
    <script src="assets/vendor/jquery.min.js"></script>

    <script type="text/javascript">
        var jQuery=$.noConflict();
    </script>

    <script src="assets/vendor/fastclick.js"></script> 

    
    <script type="text/javascript" src="assets/vendor/zepto.js"></script>
    <script src="assets/vendor/sm.min.js"></script> 

    <script src="assets/vendor/datatables.min.js"></script>
    <script src="assets/vendor/Scroller-1.4.2/js/dataTables.scroller.min.js"></script>
    <script src="assets/vendor/FixedColumns-3.2.2/js/dataTables.fixedColumns.min.js"></script>
    <script src="assets/vendor/FixedHeader-3.1.2/js/dataTables.fixedHeader.min.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
    <script src="assets/js/lang.js"></script>
    <script src="assets/js/common.js"></script>
<script>
  $(function() {
    FastClick.attach(document.body);
  });

</script> 

<!-- 
<script src="assets/api/api.config.js"></script>
<script src="assets/api/api.js"></script> -->



<script>
var xhr,xhr1;
var _ID = 0;
var _count ;//获取侧滑id
var _NUM = {'product':0,'gift':0};
var _time_interval = false;
var shop_id = getUrlParameter('shop_id') * 1;
var lang = getUrlParameter('lang');
var _s = getUrlParameter('_s');
var _siteId = getUrlParameter('site_id');
var back_url='form.html'+ '?shop_id=' + shop_id + '&lang=' + lang + '&_s=' + _s + '&site_id=' + _siteId; 
$('.back_a').attr('href',back_url);

// 判断缓存
if(sessionStorage.getItem('result7')){
  $('.filter_result').html(sessionStorage.getItem('result7'));
}
if(sessionStorage.getItem('total7')){
  $('.filter_total').html(sessionStorage.getItem('total7'));
}

//点击弹出右侧的panel    
$(document).on("click", ".btn-panel", function() {
    var id = $(this).attr('data-rel');
    $.openPanel("#"+id);
    $('#bg').show();
    _count = "#"+id;
    $('.panel.panel-right.panel-cover'+_count+' ').show();
});
$('.panel header .back').on("click",function(){
  $('#bg').hide();
})
$('#bg').on("click",function(){
  $.closePanel(_count);
  // $('.panel.panel-right.panel-cover'+_count+' ').hide();
  $(this).hide();
  $('#date_sure').click();
})
$('.panel header .confirm').on("click",function(){
  $('#bg').hide();
})
// 点击背景可以直接回填值
$(document).on("close", ".panel", function(e, pageId, $page) {
  $(this).find('.close-panel').click();
});



// $('.relative-value').each(function(){
//     var s = $(this).attr('data-value');
//     var that = $(this);
//     $('input[name="'+s+'"]').change(function(){
//         var str = '';
//         $('input[name="'+s+'"]').each(function(){
//             if(!$(this).prop('checked')){
//                 return;
//             }
//             str += (str != '')? ',' + $(this).val() : $(this).val();
//         })
//         that.val(str);
//     })
// })



jQuery(document).ready(function($){
  $('.filterButton').click(function(){
    $('.filter').addClass('hidden');
    $('#container > .condition').removeClass('hidden');
  })

  $('#getList').click(function(){
      if(ajax_count!=2){
        return false;
      }
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
  })
  // 筛选
  var flag = true; 
  $('.menuRight').click(function(){
    if(ajax_count!=2){
      return false;
    }
    if(flag){
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
      $('.data').removeClass('hidden');
      flag = false;
    }else{
      $('.filter').addClass('hidden');
      $('#container > .condition').removeClass('hidden');
      $('.data').addClass('hidden');
      flag = true;
    }
  })


  var date = new Date();
  var didDate = date.setDate(date.getDate()-6);
  var year = date.getFullYear();
  var month = date.getMonth()+1;
  var day = date.getDate();
  if(String(month).length == 1){
    month = '0' + month;
  }
  if(String(day).length == 1){
    day = '0' + day;
  }
  var year_month_day = year + '-' + month + '-' + day +'';
  if(sessionStorage.getItem('start7')){
    $('.startDate').text(sessionStorage.getItem('start7'));
    $('input[name=start_at]').val(sessionStorage.getItem('start7'))
  }else{
    $('input[name=start_at]').val(year_month_day);
    $('.startDate').text($('input[name=start_at]').val());
  }
  if(sessionStorage.getItem('end7')){
    $('.endDate').text(sessionStorage.getItem('end7'));
    $('input[name=end_at]').val(sessionStorage.getItem('end7'))
  }else{
    $('input[name=end_at]').val(new Date().Format("yyyy-MM-dd"));
    $('.endDate').text($('input[name=end_at]').val());
  }

  $('input[name=start_at]').change(function(){
    var start_at = $('input[name=start_at]').val();
    var end_at = $('input[name=end_at]').val();
    if(start_at > end_at ){
      $('input[name=start_at]').val($('input[name=end_at]').val())
    }
    $('.startDate').text($('input[name=start_at]').val()); 
    $('.endDate').text($('input[name=end_at]').val());
    sessionStorage.setItem('start7',start_at);
  })
  $('input[name=end_at]').change(function(){
    var start_at = $('input[name=start_at]').val();
    var end_at = $('input[name=end_at]').val();
    if(start_at > end_at ){
      $('input[name=end_at]').val($('input[name=start_at]').val())
    }
    $('.startDate').text($('input[name=start_at]').val()); 
    $('.endDate').text($('input[name=end_at]').val());
    sessionStorage.setItem('end7',end_at);
  })

  $('.nx-btn-product-search').click(function(){
    var val = $.trim($('#productCode').val());
    var r = /^\d+$/;

    if(r.test(val) == true)  
     {  
        if(val.length < 6){
          showError('SKU至少输入6位');
          $('#productCode').focus();
          return false;
        }else{
          clearError();
        }
     }  
    else  
    {  
      if(val.length < 2){
        showError('商品名称至少输入2个字符');
        $('#productCode').focus();
        return false;
      }else{
        clearError();
      }
    }  
      tab2_click_callback();
    })


    // $('.nx-btn-gift-search').click(function(){
    //   var val = $.trim($('#giftCode').val());
    //   var r = /^\d+$/;

    //   if(r.test(val) == true)  
    //    {  
    //       if(val.length < 6){
    //         showError('SKU至少输入6位');
    //         $('#giftCode').focus();
    //         return false;
    //       }
    //    }  
    //   else  
    //   {  
    //       if(val.length < 2){
    //         showError('商品名称至少输入2个字符');
    //         $('#giftCode').focus();
    //         return false;
    //       }
    //   }  
    //   tab3_click_callback();
    // })

      var table_example;

      var TABLE = '';
      function reset(){
        if(!!table_example){
            table_example.destroy();
        }
        table_example='';
        $('.data table').remove();
        var t = TABLE.clone();
        $('.data').append(t);
      }
      TABLE = $('.data table').clone();

        var render_table_example1 = function(cols){
          // if(typeof table_example !== 'undefined'){
          //     table_example.destroy();
          // }

        var _columns = [];
        var _columns_sort = ['category_code','category_name'];
        for(var i = 0; i < cols.length; i++){
          if($.inArray(cols[i], _columns_sort) >= 0){
            _columns.push({orderable:false});
          }else{
            _columns.push(null);
          }
        }
          
          table_example = $('#example').DataTable( {
            scrollX: '100%',
            scrollY: '550', 
            searching: false,
            sort:true,
            columns:_columns,
            order:[],
            "bProcessing" : true,  
            "bServerSide" : true,

            ajax:{
              url:'/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=employee_sale_status',
              type:'POST',
              dataType:'json',
              contentType:'application/json',
              data: function(d){
                // if($('.wrapper').attr('data-mode') == 'day'){
                //   d.end_date = $('.start').text();
                // }else{
                //   d.end_date = $('.end').text();
                // }
                // d.limit = d.length;
                // d.offset = d.start;
                // d.current_page = 1 + d.start / d.limit;
                // d.shop_id = shop_id;
                // d.start_date = $('input[name=start_at]').val();
                // // d.end_date = $('input[name=end_at]').val();
                // d.calc_type = $('input[name=total]:checked').val();
                // d.show_as = $('input[name=result]:checked').val();
                // d.signature = _s;
                
                // if(d.order.length > 0){
                //   var _order_by = $('.dataTables_scrollHead th:eq('+d.order[0].column+')').attr('data-code');
                //   var _is_desc = (d.order[0].dir == 'asc')?0:1;

                //   d.order_by= _order_by;
                //   d.is_desc= _is_desc;
                // }
                var d2 = {};
                if($('.wrapper').attr('data-mode') == 'day'){
                  d2.end_date = $('.start').text();
                }else{
                  d2.end_date = $('.end').text();
                }
                d2.limit = d.length;
                d2.offset = d.start;
                d2.current_page = 1 + d.start / d2.limit;
                d2.shop_id = shop_id;
                d2.start_date = $('input[name=start_at]').val();
                // d.end_date = $('input[name=end_at]').val();
                d2.calc_type = $('input[name=total]:checked').val();
                d2.show_as = $('input[name=result]:checked').val();
                d2.signature = _s;
                
                if(d.order.length > 0){
                  var _order_by = $('.dataTables_scrollHead th:eq('+d.order[0].column+')').attr('data-code');
                  var _is_desc = (d.order[0].dir == 'asc')?0:1;

                  d2.order_by= _order_by;
                  d2.is_desc= _is_desc;
                }
                return (JSON.stringify(d2));
              },
              dataSrc:  function(data){
                  $('.data_content').hide();
                  records = [];
                  if(data['records']){
                    for(var i = 0 ; i < data['records'].length ; i ++){
                      var _data = [];
                        for(var j=0; j < cols.length; j++){
                          _data.push(data['records'][i][cols[j]]);
                        }
                        records.push(_data);
                    }
                  }
                  return records
                },
              },

              "initComplete": function(settings, json) {
                  $('#mainFooter').html('');
                  $('#example_length').appendTo('#mainFooter');
                  $('#example_info').appendTo('#mainFooter');
                  $('#example_paginate').appendTo('#mainFooter');

              },
              "lengthMenu": [ [10 , 20, 50, 80], _LANG_SHOW['page_change'] ],
              "language":   _LANG_SHOW['_LANG']

            } );

          new $.fn.dataTable.FixedColumns( table_example, {
              leftColumns: 1
          } );

        }

        var ajax_count = 0;// 执行了几个ajax
        $('.nx-btn-display').css('background','#b3b3b3');

        //init 展示结果
        if(xhr){
          xhr.abort();
        }
        xhr = $.ajax({
          url: '/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=employee_sale_show_as',
          data: JSON.stringify({signature:_s}),
          type: 'POST',
            dataType : "json",
            contentType: "application/json",
          success:  function(data){
                    var str = '';
                    for(i=0;i<data.data.length;i++){
                        var name = data.data[i]['type_name'];
                        var code = data.data[i]['type_code'];
                        str += '<li><label class="lb" for="result'+i+'">\
                  '+ name +'\
                  <span class="checkbox">\
                    <span class="input-radio">\
                      <input type="radio" name="result" id="result'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                      <span class="inner"></span>\
                    </span>\
                  </span></label>\
                </li>';
                    }
                $('#panel-result ul').html(str);
                $(document).on("click", "#panel-result .close-panel.confirm_1", function() {
                  var s = '';
                  if($(this).parents('.panel').find('input[type=radio]').size() == $(this).parents('.panel').find('input[type=radio]:checked').size()){
                    s = '全部结果';
                  }else{

                    $(this).parents('.panel').find('input[type=radio]:checked').each(function(){
                        if(s != ''){
                            s += ',';
                        }
                        s +=  $(this).attr('data-label');
                    });
                  }
                  $('input[data-value="storage1"]').val(s);
                  sessionStorage.setItem('result7',s);
                  $('.filter_result').html(s);

              });
              // 默认选中
              $('#panel-result ul li:first-child .input-radio input').click();
              $('#panel-result .close-panel.confirm_1').click();

              //初始点击
              // $('#getList').click();
              ajax_count++;
              if(ajax_count==2){
                $('.nx-btn-display').css('background','#0894ec');
              }else{
                $('.nx-btn-display').css('background','#b3b3b3');
              }
          },
          error:    function(d){
            if(d.responseJSON.code == -11){
              if(typeof js_bridge == 'object'){

                js_bridge.callHandler('webviewForceRefresh', 
                    {   
                    }, function(response) {
                })
              }
            }
            console.log('error');
            
          },
          complete: function(){
            console.log('complete');
          },
          beforeSend : function(){
          }
        })

        //init 统计方式
        if(xhr1){
          xhr1.abort();
        }
        xhr1 = $.ajax({
          url: '/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=employee_sale_calc_type',
          data: JSON.stringify({signature:_s}),
          type: 'POST',
            dataType : "json",
            contentType: "application/json",
          success:  function(data){
                    var str = '';
                    for(i=0;i<data.data.length;i++){
                        var name = data.data[i]['type_name'];
                        var code = data.data[i]['type_code'];
                        str += '<li><label class="lb" for="total'+i+'">\
                  '+ name +'\
                  <span class="checkbox">\
                    <span class="input-radio">\
                      <input type="radio" name="total" id="total'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                      <span class="inner"></span>\
                    </span>\
                  </span></label>\
                </li>';
                    }
                $('#panel-total ul').html(str);
                $(document).on("click", "#panel-total .close-panel.confirm_2", function() {
                    var s = '';
                    if($(this).parents('.panel').find('input[type=radio]').size() == $(this).parents('.panel').find('input[type=radio]:checked').size()){
                      s = '全部统计方式';
                    }else{

                      $(this).parents('.panel').find('input[type=radio]:checked').each(function(){
                          if(s != ''){
                              s += ',';
                          }
                          s +=  $(this).attr('data-label');
                      });
                    }
                    $('input[data-value="storage2"]').val(s);
                    sessionStorage.setItem('total7',s);
                    $('.filter_total').html(s);

                });
                // 默认选中
              $('#panel-total ul li:first-child .input-radio input').click();
              $('#panel-total .close-panel.confirm_2').click();

            //初始点击
            // $('#getList').click();
            ajax_count++;
            if(ajax_count==2){
              $('.nx-btn-display').css('background','#0894ec');
            }else{
              $('.nx-btn-display').css('background','#b3b3b3');
            }
          },
          error:    function(d){
            if(d.responseJSON.code == -11){
              if(typeof js_bridge == 'object'){

                js_bridge.callHandler('webviewForceRefresh', 
                    {   
                    }, function(response) {
                })
              }
            }
            console.log('error');
            
          },
          complete: function(){
            console.log('complete');
          },
          beforeSend : function(){
          }
        })

        //click search
        $('.nx-btn-display').click(function(){
          if(ajax_count!=2){
            return false;
          }
          $('.data_content').show();
          flag = false;
          $('.data').removeClass('hidden');
          $('.allDate').html($('input[name=start_at]').val() +'至'+ $('input[name=end_at]').val() );
            if($(this).hasClass('disabled')){
                return;
            }
            $(this).addClass('disabled');
            $(this).html('加载中');
            reset();
            var Enddate;
            if($('.wrapper').attr('data-mode') == 'day'){
              Enddate = $('.start').text();
            }else{
              Enddate = $('.end').text();
            }
            var data = {
                current_page:1,
                limit:10,
                shop_id:shop_id,
                start_date:$('input[name=start_at]').val(),
                end_date: Enddate,
                // end_date:$('input[name=end_at]').val(),
                calc_type:$('input[name=total]:checked').val(),
                show_as:$('input[name=result]:checked').val(),
                signature:_s,
                header_only:1
            };

            //销售统计查询
            if(xhr){
              xhr.abort();
            }  
            xhr = $.ajax({
              url: '/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=employee_sale_status',
              data: JSON.stringify(data),
              type: 'POST',
                dataType : "json",
                contentType: "application/json",
              success:  function(data){
                records = [];
                if(data['records']){
                  for(var i = 0 ; i < data['records'].length ; i ++){
                    records.push([
                      data['records'][i]['sale_code'],
                      data['records'][i]['brand'],
                      data['records'][i]['sale_count'],
                      data['records'][i]['sale_amount'],
                      data['records'][i]['stock_count'], 
                      data['records'][i]['stock_amount']
                    ])
                  }
                }
                var _data = {
                    headers:[
                    {title : data.table_headers.sale_code},
                    {title : data.table_headers.brand},
                    {title : data.table_headers.sale_count},
                    {title : data.table_headers.sale_amount},
                    {title : data.table_headers.stock_count},
                    {title : data.table_headers.stock_amount}
                    ],
                    records:records
                };

                var _data = {};
                var cols = [];
                var headers = [];
                var records = [];
                for(var i = 0 ; i < data.table_headers.length ;i++){
                  for(var ss in data.table_headers[i]){
                    headers.push({title : data.table_headers[i][ss]});
                    cols.push(ss);
                    if($('table thead tr').length == 1){
                      $('table thead tr').append('<th data-code = "'+ss+'">'+data.table_headers[i][ss]+'</th>');
                    }
                  }
                }
                // for(var i = 0 ; i < data.records.length; i++){
                //     var tmp = [];
                //     for(var j=0;j<cols.length;j++){
                //         tmp[j] = data.records[i][cols[j]];
                //     }
                //     records.push(tmp);
                // }
                // _data.records = records;
                // _data.headers = headers;
                render_table_example1(cols);

                },
                error:    function(d){
                  if(d.responseJSON.code == -11){
                    if(typeof js_bridge == 'object'){

                      js_bridge.callHandler('webviewForceRefresh', 
                          {   
                          }, function(response) {
                      })
                    }
                  }
                  console.log('error');
                  
                },
                complete: function(){
                  console.log('complete');
                },
                beforeSend : function(){
                }
            })

            console.dir(data);


            $(this).removeClass('disabled');
            $(this).html('查询');
        })







  function showDetail(id,time_interval){
    $('body').addClass('show_detail');

    $(document).on("click", "#detailContent .back", function() {
        $('body').removeClass('show_detail');
    });

    $('#detailContent .condition input').val('');

    $('.resultRecord').html('统计中...');
    clearError();
    //$('a[href="#tab1"]').click();
    $('.tab-link').removeClass('active');
    $('.tab-link[href="#tab1"]').addClass('active');
    $('.tabs .tab').removeClass('active');
    $('.tabs #tab1').addClass('active');
    

    // if((typeof tbl['tblProduct'] !== 'undefined') && (tbl['tblProduct'] != '')){
    //                     tbl['tblProduct'].destroy();
    //                 }
    // if((typeof tbl['tblGift'] !== 'undefined') && (tbl['tblGift'] != '')){
    //                     tbl['tblGift'].destroy();
    //                 }



    var id = id;//getUrlParameter('id');
    _ID = id;
    _time_interval = time_interval;

    $('.tab-link[href="#tab1"]').click();
    tab1_click_callback();


    get_num('product');
    //get_num('gift');


    
  }

  //get number
  function get_num(type){
        var _data = {
          rule_id:_ID,
          type:type
        };

        $.ajax({
          url: '/nt_project_lingzhi/web_mobile/api?object=nt.pos.html&method=lingzhi_promotion_rule_product_count',
            data: JSON.stringify(_data),
            type: 'POST',
            dataType : "json",
            contentType: "application/json",
          success:  function(data){
            _NUM[type] = data.total;

            $('.cx-product:not(.cx-gift) .resultRecord').html('总共 '+_NUM['product'] + ' 条');
            $('.cx-gift .resultRecord').html('总共 '+_NUM['gift'] + ' 条');
          },
          error:    function(){
            
          },
          complete: function(){
          },
          beforeSend : function(){
          }
        })
  }



  //init detail 3page


    $('.hasext').click(function(){
        $(this).toggleClass('ext');
        if($(this).hasClass('ext')){
            $(this).next('.wrap').slideDown();
        }else{
            $(this).next('.wrap').slideUp();
        }
    })

    var tbl = {
        tblProduct:'',
        tblGift:'',
    };

            var render_table_example = function(id,data){

                    if((typeof tbl !== 'undefined') && (typeof tbl[id] !== 'undefined') && (tbl[id] != '')){
                        tbl[id].destroy();
                    }

                    tbl[id] = $('#'+id).DataTable( {
                        data: data.records,
                        columns: data.headers,
                        scrollX: '100%',
                        scrollY: '360',//768 - 70 - 50 - 50 - 50 - 66 
                        //searching: false,
                        sort:false,
                        // fixedHeader: {
                        //     header: true,
                        //     footer: true
                        // },
                        "initComplete": function(settings, json) {
                            $('#detailContent footer').html('');
                            $('#detailContent footer').removeClass('hidden');
                            $('#'+id + '_length').appendTo('#detailContent footer');
                            $('#'+id + '_info').appendTo('#detailContent footer');
                            $('#'+id + '_paginate').appendTo('#detailContent footer');
                            $('tr.odd').removeClass('odd');
                            $('tr.even').removeClass('even');

                            if(id == 'tblProduct'){
                              $('.cx-product:not(.cx-gift) footer').removeClass('hidden');
                            }
                            if(id == 'tblGift'){
                              $('.cx-gift footer').removeClass('hidden');
                            }

                          },
                        "lengthMenu": [ [10 , 20, 50, 80], _LANG_SHOW['page_change'] ],
                            "language":   _LANG_SHOW['_LANG']



                    } )


                    $('.button[data-table="#'+id+'"]').unbind('click').bind('click',function(){
                        $('#'+id).DataTable()
                        .search( $(this).parents('.condition').find('input').val() )
                        //.search('ABC')
                        .draw();

                    })


                    // new $.fn.dataTable.FixedColumns( table_example, {
                    //         leftColumns: 1
                    //     } );

            }



})



</script>

  <script>
    var _paq = _paq || [];
    window.onload = function () {
      setTimeout(function() {
        _paq.push(['enableLinkTracking', true]);
        (function() {
          try {
            var storage, SiteId, UserId;
            if(!!window.sessionStorage){
                storage = window.sessionStorage;
                SiteId = getUrlParameter('SiteId') || storage.getItem("SiteId") || P_SiteId;
                UserId = getUrlParameter('UserId') || storage.getItem("UserId") || '';
            }else{
                SiteId = getUrlParameter('SiteId') || P_SiteId;
                UserId = getUrlParameter('UserId') || '';
            }
            
            if(!!window.sessionStorage){
                storage = window.sessionStorage;
                storage.setItem("SiteId", SiteId);
                storage.setItem("UserId", UserId);
            }
            // 如果site_id是false,则不发送Piwik数据
            if(SiteId == '' || SiteId == false){
                return
            }

            var u="http://a2.nexttao.com/";
            // 当url为空不发送
            if(u == "" || u == "false" || u == false){
                return
            }
            if(!!UserId){
                _paq.push(['setUserId', UserId]);
            }
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', SiteId]);
            _paq.push(['setDocumentTitle', '员工查询/销售分析']);
            _paq.push(['setCustomVariable',"5","AppVersion",P_CV.AppVersion,'page']);
            _paq.push(['trackPageView']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          }catch (e){
            console.log(e);
          }
        })();
      }, 200);
    }
  </script>
</body>
</html>
