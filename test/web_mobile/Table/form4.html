<html ng-app="NtCuxiao">
<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1, maximum-scale=1.0, user-scalable=no"> 
  <meta content="telephone=no" name="format-detection" />  
  <script>
    if (document.documentElement.clientWidth > 1024) { 
      document.querySelector("meta[name=viewport]").setAttribute(
        'content', 
        'width=1024, initial-scale='+(document.documentElement.clientWidth/1024)+', minimum-scale=0.1, maximum-scale=2.0, user-scalable=no');
    }
  </script>
  <link href="assets/css/css.css?r=1849920396" media="screen" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/datatables.css">
  <link rel="stylesheet" href="assets/vendor/sm.min.css">
  <link href="assets/css/style.css"  media="screen" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/sm-nx.css">
  <link rel="stylesheet" href="assets/js/daterangepicker.min.css">
  <script src="project.js"></script>
  <script src="assets/js/get_lang_json.js"></script>
</head>

<body class="debugx">
  <div id="bg"></div>
  <div id="bg_img"></div>
  <div id="container">
    <header>
      <span class="menu"></span>
      <a class="back_a" href=""><span class="menuBack"></span></a>
      <span tkey="form2"></span><span class="blue" tkey="form4_tittle"></span>
      <span class="menuRight" tkey="filter"></span>
    </header>
    <section class="filter hidden">
      <span tkey="filters"></span>
      <!-- <span tkey="circle"></span>（<span class="filter_reason4"></span>）; -->
      <span tkey="condi_brand"></span> : <span class="filter_brand"></span>;
      <span tkey="date1"></span>（<span class="startDate"></span><span class="date_line">/</span><span class="endDate"></span>）;
      <span tkey="date2"></span>（<span class="startDate2"></span><span class="date_line2">/</span><span class="endDate2"></span>）
    </section>
    <div class="condition">
      <div class="row" >
      <ul class="col-50">
        <!-- 品牌brand -->
        <li>
          <div class="item-content item-relative">
            <label><span tkey="condi_brand"></span>:</label>
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder-key="desc_brand" class="btn-panel relative-value" data-rel="panel-brand" readonly="" data-value="brand" value="">
            </div>
          </div>
        </li>
        <!-- 周期1 -->
        <li style="position: relative;">
          <div id="datepicker1" class="alert_block datepicker">
            <img src="/nt_pos/web_mobile/static/lzsale/src/img/cuxiao/date.png" />
          </div>
          <div class="wrapper">
            <div class="dataTab">
              <ul>
                <li id="dp-day">
                  <label for="mode_day" class="block active">
                    <input name="mode" type="radio" value="day" id="mode_day" /><span tkey="day"></span>
                  </label>
                </li>
                <li id="dp-week">
                  <label for="mode_week" class="block">
                    <input name="mode" type="radio" value="week" id="mode_week" /><span tkey="week"></span>
                  </label>
                </li>
                <li id="dp-month">
                  <label for="mode_month" class="block">
                    <input name="mode" type="radio" value="month" id="mode_month" /><span tkey="month"></span> 
                  </label>
                </li>
                <li id="dp-range">
                  <label for="mode_range" class="block" style="border-right:1px solid #2699de">  
                    <input name="mode" type="radio" value="customize" id="mode_range"/><span tkey="customize"></span> 
                  </label>
                </li>
              </ul>
              <button id="date_sure" tkey="sure"></button>
            </div>
            <div class="picker" style="width:850px" id="pickerBox">
              <div style="float:left;width:100%">
                <div id="pickerContainer"></div>
                <div class="shopForce"><img src="/nt_pos/web_mobile/static/lzsale/src/img/cuxiao/Group.png"/></div>
              </div>
            </div>
          </div>
          <div class="date_text date_text1">
            <span class="start"></span>
            <span class="icondate">/</span>
            <span class="end"></span>
          </div>
        </li>
        <!-- 周期2 -->
        <li style="position: relative;">
          <div id="datepicker" class="alert_block datepicker cannot_click">
            <img src="/nt_pos/web_mobile/static/lzsale/src/img/cuxiao/date.png" />
          </div>
          <div class="date_text date_text2">
            <span class="start"></span>
            <span class="icondate">/</span>
            <span class="end"></span>
          </div>
        </li> 
        <!-- O 环比 | O 同比 | O 自定义 -->
        <li class="radio_btn" onclick="radio_change()">
          <div class="chain_ratio" class="">
            <img class="checked" src="/nt_pos/web_mobile/static/lzsale/src/img/radio-on.png" alt="">
            <img src="/nt_pos/web_mobile/static/lzsale/src/img/radio-off.png" alt=""> <span data-id="chain_ratio" tkey="cir_compare">环比</span> 
          </div>
          <div class="year_on_year">
            <img src="/nt_pos/web_mobile/static/lzsale/src/img/radio-on.png" alt="">
            <img class="checked" src="/nt_pos/web_mobile/static/lzsale/src/img/radio-off.png" alt=""> <span data-id="year_on_year" tkey="same_compare">同比</span>
          </div>
          <div class="custom">
            <img src="/nt_pos/web_mobile/static/lzsale/src/img/radio-on.png" alt="">
            <img class="checked" src="/nt_pos/web_mobile/static/lzsale/src/img/radio-off.png" alt=""> <span data-id="year_on_year" tkey="customize">自定义</span>
          </div>
        </li>
        <!-- 按钮 -->
        <li>
          <div class="item-content no-border item-button" style="margin-top: 40px">
            <!-- <button class="button button-fill button-primary" id="clear" tkey="clear">重置</button> -->
            <button class="button button-fill button-primary nx-btn-display" id="getList" data-table="#example" style="margin-left: 0px;" tkey="search"></button>
          </div>
        </li>
        </ul>
      </div>
    </div>
    <div class="data hidden ">
      <table class="display nx-datatables" id="example" width="100%">
      </table>
      <!-- loading -->
      <div class="data_content">
        <div class="loading"></div>
        <!-- loading -->
        <div class="loader loader--style1" title="0">
          <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
          <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
            s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
            c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
          <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
            C22.32,8.481,24.301,9.057,26.013,10.047z">
            <animateTransform attributeType="xml"
              attributeName="transform"
              type="rotate"
              from="0 20 20"
              to="360 20 20"
              dur="0.5s"
              repeatCount="indefinite"/>
            </path>
          </svg>
          <p>加载中...</p>
        </div>  
      </div>
      <footer id="mainFooter">
      </footer>
    </div>
  </div>

  <!-- 零售查询 -->
  <!-- * 销售环比 -->
  <!-- 汇总 -->
  <div class="panel panel-right panel-cover" id='panel-reason4'>
    <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="circle"></span>
    <a href="#" class="close-panel confirm confirm" tkey="sure"></a>
    </header>
    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small" tkey="total_desc"></p>
      <ul>
        <!-- Single chekbox item -->
        <li tkey="loading"></li>
      </ul>
    </div>
  </div>

  <!-- 品牌 -->
  <div class="panel panel-right panel-cover" id='panel-brand'>
    <header>
      <a href="#" class="close-panel back"></a>  
      <span tkey="condi_brand"></span>
      <a href="#" class="close-panel confirm confirm_1" tkey="sure"></a>
    </header>
    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small" >* <span tkey="desc_brand"></span></p>
      <ul>
        <!-- Single chekbox item -->
        <li tkey="loading"></li>
      </ul>
    </div>
  </div>

  <script src="assets/vendor/jquery.min.js"></script>
  <script type="text/javascript">
      var jQuery=$.noConflict();
  </script>
  <script src="assets/vendor/fastclick.js"></script> 
  <script type="text/javascript" src="assets/vendor/zepto.js"></script>
  <script src="assets/vendor/sm.min.js"></script> 
  <script src="assets/vendor/datatables.min.js"></script>
  <script src="assets/vendor/Scroller-1.4.2/js/dataTables.scroller.min.js"></script>
  <script src="assets/vendor/FixedColumns-3.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="assets/vendor/FixedHeader-3.1.2/js/dataTables.fixedHeader.min.js"></script>
  <script type="text/javascript" src="assets/js/main.js"></script>
  <script src="assets/js/lang.js"></script>
  <script src="assets/js/common.js"></script>
  <script src="assets/js/moment.min.js"></script>
  <script src="assets/js/jquery.daterangepicker.min.js"></script>
  <script src="assets/js/demo.js"></script>
  <script>
    $(function() {
      FastClick.attach(document.body);
    });
  </script>
<script>
var xhr, xhr1, date_click=false;
var form_id = 'form4';
var tong_huan_type = 'huan'
var _ID = 0;
var _count ;//获取侧滑id
var _NUM = {'product':0,'gift':0};
var _time_interval = false;
var shop_id = getUrlParameter('shop_id') * 1;
var lang = getUrlParameter('lang');
var _s = getUrlParameter('_s');
var _siteId = getUrlParameter('site_id');
var back_url='form.html'+ '?shop_id=' + shop_id + '&lang=' + lang + '&_s=' + _s + '&site_id=' + _siteId; $('.back_a').attr('href',back_url);
// 判断缓存
if(sessionStorage.getItem('reason4')){
  $('.filter_reason4').html(sessionStorage.getItem('reason4'));
}

// 环比、同比、自定义
function radio_change(){
  var target_innerText = ''
  if(event.target.innerText==_LANG_SHOW['cir_compare'] ||event.target.innerText==_LANG_SHOW['same_compare']||event.target.innerText==_LANG_SHOW['customize']){
    target_innerText = event.target.innerText
  }else{
    if(event.target.innerText == ''){
      target_innerText = event.target.parentNode.innerText.replace(/\n/g,"")
    }else{
      return
    }
  }
  for (var i=0;i<event.currentTarget.children.length;i++){
    if(event.currentTarget.children[i].innerText.replace(/\n/g,"")  == target_innerText){
      event.currentTarget.children[i].children[0].className = 'checked'
      event.currentTarget.children[i].children[1].className = ''
    }else{
      event.currentTarget.children[i].children[0].className = ''
      event.currentTarget.children[i].children[1].className = 'checked'
    }
  }

  console.log(target_innerText)
  var date1 = $('.date_text1 .start').text()
  var date2 = $('.date_text1 .end').text()
  if(target_innerText == _LANG_SHOW['cir_compare']){
    tong_huan_type = 'huan'
    $('.datepicker')[1].className = 'alert_block datepicker cannot_click'
    if(!!date2){
      var huan_date = dateHuanDate(date1,date2)
      $('.date_text2 .start').text(huan_date[0]);
      $('.date_text2 .end').text(huan_date[1]);
      $('.date_text2 .icondate').show();
    }else{
      $('.date_text2 .start').text(getDateNum(date1, -1));
      $('.date_text2 .end').text(date2);
      $('.date_text2 .icondate').hide();
    }
    
    // $('.date_text1 .start').text(week_start_date);
    // $('.date_text1 .end').text(week_end_date);
    // $('.date_text2 .start').text(week_start_date1);
	  // $('.date_text2 .end').text(PreDate);
  }else if(target_innerText == _LANG_SHOW['same_compare']){
    tong_huan_type = 'tong'
    $('.datepicker')[1].className = 'alert_block datepicker cannot_click'
    $('.date_text2 .start').text(getLastYearDay(date1));
    if(!!date2){
      $('.date_text2 .end').text(getLastYearDay(date2, true));
      $('.date_text2 .icondate').show();
    }else{
      $('.date_text2 .end').text(date2);
      $('.date_text2 .icondate').hide();
    }
    
    // $('.date_text1 .start').text(week_start_date);
    // $('.date_text1 .end').text(week_end_date);
    // var last_year_week_date = year_month_day.substring(0,4)-1 + year_month_day.substring(4, year_month_day.length)
    // if(!check_date(last_year_week_date)){
    //   last_year_week_date = last_year_week_date.substring(0,last_year_week_date.length-2) + (last_year_week_date.substring(last_year_week_date.length-2, last_year_week_date.length)-1)
    // }
    // var last_year_week = getWeek(last_year_week_date)
    // $('.date_text2 .start').text(last_year_week[0]);
	  // $('.date_text2 .end').text(last_year_week[1]);
  }else{
    var date_text2_start = sessionStorage.getItem('date_text2_start')
    var date_text2_end = sessionStorage.getItem('date_text2_end')
    if(!!date_text2_start){
      $('.date_text2 .start').text(date_text2_start);
    }
    $('.date_text2 .end').text(date_text2_end);
    $('.date_text2 .icondate').hide()
    if(!!date_text2_end){
      $('.date_text2 .icondate').show()
    }
    tong_huan_type = 'customize'
    $('.datepicker').removeClass('cannot_click')
  }
}

//点击弹出右侧的panel    
$(document).on("click", ".btn-panel", function() {
    var id = $(this).attr('data-rel');
    $.openPanel("#"+id);
    $('#bg').show();
    _count = "#"+id;
    $('.panel.panel-right.panel-cover'+_count+' ').show();
});
$('.panel header .back').on("click",function(){
  $('#bg').hide();
})
$('#bg').on("click",function(){
  $.closePanel(_count);
  // $('.panel.panel-right.panel-cover'+_count+' ').hide();
  $(this).hide();
  $('.wrapper').hide();
  $('#date_sure').click();
})
$('.panel header .confirm').on("click",function(){
  $('#bg').hide();

})
// 点击背景可以直接回填值
$(document).on("close", ".panel", function(e, pageId, $page) {
  $(this).find('.close-panel').click();
});

// $('.relative-value').each(function(){
//     var s = $(this).attr('data-value');
//     var that = $(this);
//     $('input[name="'+s+'"]').change(function(){
//         var str = '';
//         $('input[name="'+s+'"]').each(function(){
//             if(!$(this).prop('checked')){
//                 return;
//             }
//             str += (str != '')? ',' + $(this).val() : $(this).val();
//         })
//         that.val(str);
//     })
// })

jQuery(document).ready(function($){
  // 通过url获取shop_id
  function getShopId(str){
      var url = location.href;
      var index = url.indexOf(str) + 8,//等于号后面一个字符开始检测
          fixed_index = url.indexOf(str) + 8,
          reg = /\d/,
          i = 0, //标记shop_id后面有几个数字, 这一串完整的数字是id
          id = 0;
      function getNums(index) {
          if(reg.test(url.substr(index, 1))){
              i++;
              getNums(++index);
          }
      }
      getNums(index);
      id = url.substr(fixed_index, i);
      return parseInt(id);
  }

  // 筛选
  var flag = true; 
  $('.menuRight').click(function(){
    if(flag){
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
      $('.data').removeClass('hidden');
      flag = false;
    }else{
      $('.filter').addClass('hidden');
      $('#container > .condition').removeClass('hidden');
      $('.data').addClass('hidden');
      flag = true;
    }
  })

  $('.filterButton').click(function(){
    $('.filter').addClass('hidden');
    $('#container > .condition').removeClass('hidden');
  })

  // $('#getList').click(function(){
  //     $('.filter').removeClass('hidden');
  //     $('#container > .condition').addClass('hidden');
  // })


  var date = new Date();
  var didDate = date.setDate(date.getDate()-6);
  var year = date.getFullYear();
  var month = date.getMonth()+1;
  var day = date.getDate();
  if(String(month).length == 1){
    month = '0' + month;
  }
  if(String(day).length == 1){
    day = '0' + day;
  }
  var year_month_day = year + '-' + month + '-' + day +'';
  // if(sessionStorage.getItem('start4')){
  //   $('.startDate').text(sessionStorage.getItem('start4'));
  //   $('input[name=start_at]').val(sessionStorage.getItem('start4'))
  // }else{
  //   $('input[name=start_at]').val(year_month_day);
  //   $('.startDate').text($('input[name=start_at]').val());
  // }
  // if(sessionStorage.getItem('end4')){
  //   $('.endDate').text(sessionStorage.getItem('end4'));
  //   $('input[name=end_at]').val(sessionStorage.getItem('end4'))
  // }else{
  //   $('input[name=end_at]').val(new Date().Format("yyyy-MM-dd"));
  //   $('.endDate').text($('input[name=end_at]').val());
  // }

  // $('input[name=start_at]').change(function(){
  //   var start_at = $('input[name=start_at]').val();
  //   var end_at = $('input[name=end_at]').val();
  //   if(start_at > end_at ){
  //     $('input[name=start_at]').val($('input[name=end_at]').val())
  //   }
  //   $('.startDate').text($('input[name=start_at]').val()); 
  //   $('.endDate').text($('input[name=end_at]').val());
  //   sessionStorage.setItem('start4',start_at);
  // })
  // $('input[name=end_at]').change(function(){
  //   var start_at = $('input[name=start_at]').val();
  //   var end_at = $('input[name=end_at]').val();
  //   if(start_at > end_at ){
  //     $('input[name=end_at]').val($('input[name=start_at]').val())
  //   }
  //   $('.startDate').text($('input[name=start_at]').val()); 
  //   $('.endDate').text($('input[name=end_at]').val());
  //   sessionStorage.setItem('end4',end_at);
  // })

  $('.nx-btn-product-search').click(function(){
    var val = $.trim($('#productCode').val());
    var r = /^\d+$/;

    if(r.test(val) == true)  
     {  
        if(val.length < 6){
          showError('SKU至少输入6位');
          $('#productCode').focus();
          return false;
        }else{
          clearError();
        }
     }  
    else  
    {  
      if(val.length < 2){
        showError('商品名称至少输入2个字符');
        $('#productCode').focus();
        return false;
      }else{
        clearError();
      }
    }  
      tab2_click_callback();
    })
    // 通过url获取shop_id
    // getShopId(str){
    //     var url = location.href;
    //     var index = url.indexOf(str) + 8,//等于号后面一个字符开始检测
    //         fixed_index = url.indexOf(str) + 8,
    //         reg = /\d/,
    //         i = 0, //标记shop_id后面有几个数字, 这一串完整的数字是id
    //         id = 0;
    //     function getNums(index) {
    //         if(reg.test(url.substr(index, 1))){
    //             i++;
    //             getNums(++index);
    //         }
    //     }
    //     getNums(index);
    //     id = url.substr(fixed_index, i);
    //     return parseInt(id);
    // },
      var table_example;
      var TABLE = '';
      function reset(){
        if(!!table_example){
            table_example.destroy();
        }
        table_example='';
        $('.data table').remove();
        var t = TABLE.clone();
        $('.data').append(t);
      }

      TABLE = $('.data table').clone();
            var render_table_example1 = function(data){
                $('.data').removeClass('hidden');
                table_example = $('#example').DataTable({
                    data: data.records,
                    columns: data.headers,
                    scrollX: '100%',
                    scrollY: '535',//768 - 68 - 50 - 50 - 65 
                    searching: false,
                    sort:false,

                "initComplete": function(settings, json) {
                  $('#mainFooter').html('');
                  $('#example_length').appendTo('#mainFooter');
                  $('#example_info').appendTo('#mainFooter');
                  $('#example_paginate').appendTo('#mainFooter');

              },
              "lengthMenu": [ [10 , 20, 50, 80], _LANG_SHOW['page_change'] ],
              "language":  _LANG_SHOW['_LANG']
              });
            }

            //init 环比
            if(xhr){
              xhr.abort();
            }
            
            xhr = $.ajax({
              url: '/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=sale_chain_ratio_section',
              data: JSON.stringify({signature: _s}),
              type: 'POST',
                dataType : "json",
                contentType: "application/json",
              success:  function(data){
                var str = '';
                for(i=0;i<data.data.length;i++){
                    var name = data.data[i]['type_name'];
                    var code = data.data[i]['type_code'];
                    str += '<li><label class="lb" for="reason4'+i+'">\
                    '+ name +'\
                    <span class="checkbox">\
                      <span class="input-radio">\
                        <input type="radio" name="reason4" id="reason4'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                        <span class="inner"></span>\
                      </span>\
                    </span></label>\
                  </li>';
                  }
                  $('#panel-reason4 ul').html(str);
                  $(document).on("click", "#panel-reason4 .close-panel.confirm", function() {
                    var s = '';
                    if($(this).parents('.panel').find('input[type=radio]').size() == $(this).parents('.panel').find('input[type=radio]:checked').size()){
                      s = '全部环比类型';
                    }else{
                      $(this).parents('.panel').find('input[type=radio]:checked').each(function(){
                          if(s != ''){
                              s += ',';
                          }
                          s +=  $(this).attr('data-label');
                      });
                    }
                    $('input[data-value="storage"]').val(s);
                    sessionStorage.setItem('reason4',s)
                    $('.filter_reason4').html(s);
                });
                // 默认选中
                $('#panel-reason4 ul li:first-child .input-radio input').click();
                $('#panel-reason4 .close-panel.confirm').click();
              },
              error:    function(d){
                if(d.responseJSON.code == -11){
                  if(typeof js_bridge == 'object'){

                    js_bridge.callHandler('webviewForceRefresh', 
                        {   
                        }, function(response) {
                    })
                  }
                }
                console.log('error');
              },
              complete: function(){
                console.log('complete');
              },
              beforeSend : function(){
              }
            })
            
            //init 品牌
            if(xhr1){
              xhr1.abort();
            }
            
            xhr1 = $.ajax({
              url: '/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=shop_prod_brand_list',
              data: JSON.stringify({shop_id:shop_id, signature: _s}),
              type: 'POST',
              dataType : "json",
              contentType: "application/json",
              success:  function(data){
                var str = '';
                for(i=0;i<data.brand_list.length;i++){
                  var name = data.brand_list[i]['brand'];
                  var code = data.brand_list[i]['id'];
                  str += '<li><label class="lb" for="brand'+i+'">\
                    '+ name +'\
                      <span class="checkbox">\
                        <span class="input-radio">\
                          <input type="radio" name="brand" id="brand'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                          <span class="inner"></span>\
                        </span>\
                      </span></label>\
                    </li>';
                  }
                  $('#panel-brand ul').html(str);
                  $(document).on("click", "#panel-brand .close-panel.confirm", function() {
                    var s = '';
                    if($(this).parents('.panel').find('input[type=radio]').size() == $(this).parents('.panel').find('input[type=radio]:checked').size()){
                      s = '全部品牌类型';
                    }else{
                      $(this).parents('.panel').find('input[type=radio]:checked').each(function(){
                          if(s != ''){
                              s += ',';
                          }
                          s +=  $(this).attr('data-label');
                      });
                    }
                    $('input[data-value="brand"]').val(s);
                    $('.filter_brand').html(s);
                });
                // 默认选中
                $('#panel-brand ul li:first-child .input-radio input').click();
                $('#panel-brand .close-panel.confirm_1').click();
              },
              error:    function(d){
                if(d.responseJSON.code == -11){
                  if(typeof js_bridge == 'object'){
                    js_bridge.callHandler('webviewForceRefresh', 
                        {   
                        }, function(response) {
                    })
                  }
                }
                console.log('error');
              },
              complete: function(){
                console.log('complete');
              },
              beforeSend : function(){
              }
            })
            
            //click search
            $('.nx-btn-display').click(function(){
              flag = false;
               $('.allDate').html($('input[name=start_at]').val() +'至'+ $('input[name=end_at]').val() );
                if($(this).hasClass('disabled')){
                    return;
                }

                var reason_ids = [];
                var type = [];
                $('input[name=reason]:checked').each(function(){
                    reason_ids.push($(this).val() * 1);
                })
                $('input[name=type]:checked').each(function(){
                    type.push($(this).val());
                })
                var Enddate,Enddate1;
                if(sessionStorage.getItem('datepicker') == 'datepicker'){
                  if($('#datepicker').attr('data-mode') == 'day'){
                    Enddate1 = $('.date_text2 .start').text();
                  }else{
                    Enddate1 = $('.date_text2 .end').text();
                    if(Enddate1==''){
                      Enddate1 = $('.date_text2 .start').text();
                    }
                  }  
                }else{
                  if($('#datepicker').attr('data-mode') == 'day'){
                    Enddate1 = $('.date_text2 .start').text();
                  }else{
                    Enddate1 = $('.date_text2 .end').text();
                    if(Enddate1==''){
                      Enddate1 = $('.date_text2 .start').text();
                    }
                  }  
                }
                if(sessionStorage.getItem('datepicker1') == 'datepicker1'){
                  if($('#datepicker1').attr('data-mode') == 'day'){
                    Enddate = $('.date_text1 .start').text();
                  }else{
                    Enddate = $('.date_text1 .end').text();
                  }  
                }else{
                  if($('#datepicker1').attr('data-mode') == 'day'){
                    Enddate = $('.date_text1 .start').text();
                  }else{
                    Enddate = $('.date_text1 .end').text();
                  } 
                }
                var shop_id = getShopId('shop_id=');
                var data = {
                  start_date : $('.date_text1 .start').text(),
                  end_date: Enddate,
                  last_start_date:$('.date_text2 .start').text(),
                  last_end_date:Enddate1,
                  shop_id:shop_id,
                  section: $('input[name=reason4]:checked').val(),
                  brand_id: $('input[name=brand]:checked').val()*1,
                  signature: _s
                }
                
                // // 品牌，比较区间 必填
                // if (!data.brand_id) {
                //   return
                // }
                // if (!data.section) {
                //   return
                // }

                $('.data').removeClass('hidden');
                $(this).addClass('disabled');
                $(this).html('加载中');
                reset();
                $('.filter').removeClass('hidden');
                $('#container > .condition').addClass('hidden');

                //销售环比查询
                if(xhr){
                  xhr.abort();
                }  
                xhr = $.ajax({
                  url: '/nt_pos/web_mobile/api?object=report.adapter.pos.html&method=sale_chain_ratio',
                  data: JSON.stringify(data),
                  type: 'POST',
                    dataType : "json",
                    contentType: "application/json",
                  success:  function(data){
                    $('.data_content').hide();
                    records = [];
                    if(data['records']){
                      for(var i = 0 ; i < data['records'].length ; i ++){
                        records.push([
                          data['records'][i]['sale_code'],
                          data['records'][i]['brand'],
                          data['records'][i]['sale_count'],
                          data['records'][i]['sale_amount'],
                          data['records'][i]['stock_count'], 
                          data['records'][i]['stock_amount']
                        ])
                      }
                    }
                    var _data = {
                        headers:[
                        {title : data.table_headers.sale_code},
                        {title : data.table_headers.brand},
                        {title : data.table_headers.sale_count},
                        {title : data.table_headers.sale_amount},
                        {title : data.table_headers.stock_count},
                        {title : data.table_headers.stock_amount}
                        ],
                        records:records
                    };

                    var _data = {};
                    var cols = [];
                    var headers = [];
                    var records = [];
                    for(var i = 0 ; i < data.table_headers.length ;i++){
                        for(var ss in data.table_headers[i]){
                            headers.push({title : data.table_headers[i][ss]});
                            cols.push(ss);
                        }
                    }
                    for(var i = 0 ; i < data.records.length; i++){
                        var tmp = [];
                        for(var j=0;j<cols.length;j++){
                            tmp[j] = data.records[i][cols[j]];
                        }
                        records.push(tmp);
                    }
                    _data.records = records;
                    _data.headers = headers;
                    render_table_example1(_data);
                    $('.startDate').text($('.date_text1 .start').text());
                    $('.startDate2').text($('.date_text2 .start').text());
                    if(sessionStorage.getItem('datepicker') == 'datepicker'){
                      if($('#datepicker').attr('data-mode') == 'day'){
                        $('.date_line2').hide();
                        $('.endDate2').hide();
                      }else{
                        if($('.date_text2 .end').text()==''){
                          $('.date_line2').hide();
                        }else{
                          $('.date_line2').show();
                        }
                        
                        $('.endDate2').show();
                        $('.endDate2').text($('.date_text2 .end').text());
                      }
                    }else{
                      if($('#datepicker').attr('data-mode') == 'day'){
                        $('.date_line2').hide();
                        $('.endDate2').hide();
                      }else{
                        if($('.date_text2 .end').text()==''){
                          $('.date_line2').hide();
                        }else{
                          $('.date_line2').show();
                        }
                        
                        $('.endDate2').show();
                        $('.endDate2').text($('.date_text2 .end').text());
                      }
                    }
                    if(sessionStorage.getItem('datepicker1') == 'datepicker1'){
                      if($('#datepicker1').attr('data-mode') == 'day'){
                        $('.date_line').hide();
                        $('.endDate').hide();
                      }else{
                        $('.date_line').show();
                        $('.endDate').show();
                        $('.endDate').text($('.date_text1 .end').text());
                      }
                    }else{
                      if($('#datepicker1').attr('data-mode') == 'day'){
                        $('.date_line').hide();
                        $('.endDate').hide();
                      }else{
                        $('.date_line').show();
                        $('.endDate').show();
                        $('.endDate').text($('.date_text1 .end').text());
                      }
                    }
                    
                    // footer
                    },
                    error:    function(d){
                      if(d.responseJSON.code == -11){
                        if(typeof js_bridge == 'object'){

                          js_bridge.callHandler('webviewForceRefresh', 
                              {   
                              }, function(response) {
                          })
                        }
                      }
                      console.log('error');
                      
                    },
                    complete: function(){
                      console.log('complete');
                    },
                    beforeSend : function(){
                    }
                })
                console.dir(data);
                $(this).removeClass('disabled');
                $(this).html('查询');
            })

  function showDetail(id,time_interval){
    $('body').addClass('show_detail');

    $(document).on("click", "#detailContent .back", function() {
        $('body').removeClass('show_detail');
    });

    $('#detailContent .condition input').val('');

    $('.resultRecord').html('统计中...');
    clearError();
    //$('a[href="#tab1"]').click();
    $('.tab-link').removeClass('active');
    $('.tab-link[href="#tab1"]').addClass('active');
    $('.tabs .tab').removeClass('active');
    $('.tabs #tab1').addClass('active');

    var id = id;//getUrlParameter('id');
    _ID = id;
    _time_interval = time_interval;

    $('.tab-link[href="#tab1"]').click();
    tab1_click_callback();
    get_num('product');
    //get_num('gift');
  }

  //get number
  function get_num(type){
      var _data = {
        rule_id:_ID,
        type:type
      };

      $.ajax({
        url: '/nt_project_lingzhi/web_mobile/api?object=nt.pos.html&method=lingzhi_promotion_rule_product_count',
          data: JSON.stringify(_data),
          type: 'POST',
          dataType : "json",
          contentType: "application/json",
        success:  function(data){
          _NUM[type] = data.total;

          $('.cx-product:not(.cx-gift) .resultRecord').html('总共 '+_NUM['product'] + ' 条');
          $('.cx-gift .resultRecord').html('总共 '+_NUM['gift'] + ' 条');
        },
        error:    function(){
          
        },
        complete: function(){
        },
        beforeSend : function(){
        }
      })
    }

    //init detail 3page
    $('.hasext').click(function(){
        $(this).toggleClass('ext');
        if($(this).hasClass('ext')){
            $(this).next('.wrap').slideDown();
        }else{
            $(this).next('.wrap').slideUp();
        }
    })

    var tbl = {
        tblProduct:'',
        tblGift:'',
    };

    var render_table_example = function(id,data){
      if((typeof tbl !== 'undefined') && (typeof tbl[id] !== 'undefined') && (tbl[id] != '')){
          tbl[id].destroy();
      }

      tbl[id] = $('#'+id).DataTable({
        data: data.records,
        columns: data.headers,
        scrollX: '100%',
        scrollY: '360',//768 - 70 - 50 - 50 - 50 - 66 
        //searching: false,
        sort:false,
        // fixedHeader: {
        //     header: true,
        //     footer: true
        // },
        "initComplete": function(settings, json){
          $('#detailContent footer').html('');
          $('#detailContent footer').removeClass('hidden');
          $('#'+id + '_length').appendTo('#detailContent footer');
          $('#'+id + '_info').appendTo('#detailContent footer');
          $('#'+id + '_paginate').appendTo('#detailContent footer');
          $('tr.odd').removeClass('odd');
          $('tr.even').removeClass('even');

          if(id == 'tblProduct'){
            $('.cx-product:not(.cx-gift) footer').removeClass('hidden');
          }
          if(id == 'tblGift'){
            $('.cx-gift footer').removeClass('hidden');
          }

        },
      "lengthMenu": [ [10 , 20, 50, 80], _LANG_SHOW['page_change'] ],
      "language":   _LANG_SHOW['_LANG']
    })
    $('.button[data-table="#'+id+'"]').unbind('click').bind('click',function(){
      $('#'+id).DataTable()
      .search( $(this).parents('.condition').find('input').val() )
      .draw();
    })
  }
})
</script>
  <script>
    var _paq = _paq || [];
    window.onload = function () {
      setTimeout(function() {
        _paq.push(['enableLinkTracking', true]);
        (function() {
          try {
            var storage, SiteId, UserId;
            if(!!window.sessionStorage){
                storage = window.sessionStorage;
                SiteId = getUrlParameter('SiteId') || storage.getItem("SiteId") || P_SiteId;
                UserId = getUrlParameter('UserId') || storage.getItem("UserId") || '';
            }else{
                SiteId = getUrlParameter('SiteId') || P_SiteId;
                UserId = getUrlParameter('UserId') || '';
            }
            
            if(!!window.sessionStorage){
                storage = window.sessionStorage;
                storage.setItem("SiteId", SiteId);
                storage.setItem("UserId", UserId);
            }
            // 如果site_id是false,则不发送Piwik数据
            if(SiteId == '' || SiteId == false){
                return
            }
            
            var u="http://a2.nexttao.com/";
            // 当url为空不发送
            if(u == "" || u == "false" || u == false){
                return
            }
            if(!!UserId){
                _paq.push(['setUserId', UserId]);
            }
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', SiteId]);
            _paq.push(['setDocumentTitle', '零售查询/销售环比']);
            _paq.push(['setCustomVariable',"5","AppVersion",P_CV.AppVersion,'page']);
            _paq.push(['trackPageView']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          }catch (e){
            console.log(e);
          }
        })();
      }, 200);
    }
  </script>
</body>
</html>
